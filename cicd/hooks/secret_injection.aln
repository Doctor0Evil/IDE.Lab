# CI/CD Hook: secret_injection.aln
# Dynamic secret injection for builds/tests using HashiCorp Vault bridge

imports:
  - "../../secrets/integrations/hashicorp_vault_bridge.aln"
  - "../../schemas/aln/validation_engine.aln"
  - "../../compliance/matrix/safe_resolution_matrix.aln"
  - "../../schemas/utilities/audit.aln"

hook:
  name: "secret_injection"
  description: "Obtain short-lived token and inject secrets as runtime handles; ensure no plaintext secrets in configs or logs"
  run:
    - alias: load_matrix
      action: "file_ops.load"
      params:
        path: "compliance/matrix/safe_resolution_matrix.aln"
    - alias: pre_check_no_plaintext
      action: "validation_engine.validate_no_plaintext_secrets"
      params:
        matrix_doc: "${{load_matrix.matrix}}"
    - alias: fail_if_plaintext
      action: "cicd.fail_if"
      params:
        condition: "${{not pre_check_no_plaintext.valid}}"
        message: "Plaintext secrets detected in matrix modules. Aborting to prevent exfiltration."
    - alias: get_short_lived_token
      action: "secrets.integrations.hashicorp_vault_bridge.issue_short_lived_token"
      params:
        vault_config: "${{load_matrix.matrix.modules | where(name == 'sealed_secret_vault') | first | config.vault_backend}}"
        ttl_seconds: 3600
    - alias: secret_handle
      action: "secrets.integrations.hashicorp_vault_bridge.inject_runtime_secret"
      params:
        token_handle: "${{get_short_lived_token}}"
        secret_path: "secret/data/ide_lab"
        secret_name: "build_token"
    - alias: set_env_handle
      action: "cicd.env_set"
      params:
        key: "VAULT_SECRET_HANDLE"
        value: "${{secret_handle.handle}}"
        mask: true
    - alias: run_build_command
      action: "cicd.run"
      params:
        command: "msbuild /t:build"
        env:
          VAULT_SECRET: "${{secret_handle.handle}}"
    - alias: run_tests_command
      action: "cicd.run"
      params:
        command: "dotnet test"
        env:
          VAULT_SECRET: "${{secret_handle.handle}}"
    - alias: revoke_token_after
      action: "secrets.integrations.hashicorp_vault_bridge.revoke_secret"
      params:
        token_handle: "${{get_short_lived_token}}"
    - alias: write_audit
      action: "audit.write_worm_entry"
      params:
        stream: "worm_local"
        record: |
          action: "secret_injection"
          status: "completed"
          matrix_version: "${{load_matrix.matrix.version}}"
          author_did: "${{load_matrix.matrix.author_did}}"
          secret_handle: "***MASKED***"
          timestamp: "${{now}}"

# End of hook
