name: ALN Core CI

on:
  push:
    paths:
      - "aln/**.aln"
      - ".github/workflows/**"
  pull_request:
    paths:
      - "aln/**.aln"
      - ".github/workflows/**"

jobs:
  aln-validate-and-test:
    runs-on: [ self-hosted, aln-no-python ]
    env:
      ALN_DIR: aln
      DID_PROXY_URL: "https://did-proxy.example.org/ci/issue" # Replace with your DID proxy URL or repo variable
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up ALN toolchain
        run: |
          curl -sSL https://get.aln.sh/install | bash
          echo "$HOME/.aln/bin" >> $GITHUB_PATH

      - name: CI policy check (ALN)
        run: |
          aln run tools.policy_check

      - name: Enforce non-Python environment
        run: |
          if command -v python || command -v python3 || command -v pip; then
            echo "Python detected but disallowed by ALN policy."
            exit 1
          fi

      - name: Install Node + Ajv
        run: |
          npm init -y
          npm install ajv@8.x ajv-formats@3.x

      - name: Convert ALN to JSON projections
        run: |
          echo "Converting .aln documents to aln-json-projection format..."
          aln run tools.to_json_projection

      - name: Run Ajv mesh sweep over ALN JSON views
        run: |
          echo "Running Ajv validation across all ALN JSON projections..."
          aln run tools.ajv_mesh_sweep

      - name: Evaluate severity gates
        run: |
          echo "Checking sevmesh-gate constraints (critical=0, high<=10)..."
          aln run tools.severity_gate
