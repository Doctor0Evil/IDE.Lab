name: Copilot Repo Policy & Governance

on:
  push:
    paths:
      - "aln/**repo_policy**.aln"
      - ".github/**"
  pull_request:
    paths:
      - "aln/**repo_policy**.aln"
      - ".github/**"

jobs:
  enforce-repo-policy:
    runs-on: [ self-hosted, aln-no-python ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up ALN toolchain
        run: |
          curl -sSL https://get.aln.sh/install | bash
          echo "$HOME/.aln/bin" >> $GITHUB_PATH

      - name: CI policy check (ALN)
        run: |
          aln run tools.policy_check

      - name: Load ALN repo policy contract
        run: |
          echo "Scanning aln/ for aln_repo_policy_contract definitions..."

      - name: Static ALN policy validation
        run: |
          echo "Run ALN schema validation and severity gates..."
          # Where Ajv mesh sweep / severity-gate tooling plugs in

      - name: Block disallowed Copilot/CI patterns
        run: |
          echo "Checking for Python runtimes, weakened constraints, or policy regressions..."

      - name: Run Copilot metaprompt tests
        run: |
          echo "Validating Copilot metaprompt integrity and governance alignment..."
          aln run tools.copilot_metatest
